<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Agriculture Sensor Network: Temperature</title>
    <link href="mystyle.css" rel="stylesheet" type="text/css">
    <script language="javascript" type="text/javascript" src="./flotGraphing/jquery.js"></script>
    <script language="javascript" type="text/javascript" src="./flotGraphing/jquery.flot.js"></script>
    <script language="javascript" type="text/javascript" src="./flotGraphingjquery.flot.time.js"></script>
    <script type="text/javascript">
                    
    $(function() { 
        var newest_clock = 0
        var options;
        
        // configure the options for different views
        function set_option_recent(){
            options = {
                lines:  { show: true },
                points: { show: true },
                xaxis:  { mode: "time"},
            };
        }
        function set_option_today(){
            var epoch_time = (new Date).getTime();
            options = {
                lines:  { show: true },
                xaxis: { 
                    mode: "time",
                    min: epoch_time-86400000,
                    max: epoch_time
                },
            };
        }
        function set_option_all(){
            options = {
                lines:  { show: true },
                xaxis: { mode: "time" },
            };
        }
      
        // set up the clicks
        var current_option = "recent"
        $("#recent").click(function () {
            current_option = "recent"
            updateGraphData(current_sensor_data);
        });
        $("#today").click(function () {
            current_option = "today"
            updateGraphData(current_sensor_data)              
        });
        $("#all").click(function () {
            current_option = "all"
            updateGraphData(current_sensor_data)
        });
      
        //process get new data
        var get_data_clicked = false
        $("#getdata").click(function () {
            var mygetrequest = new XMLHttpRequest();
            /*mygetrequest.onreadystatechange=function(){
                if (mygetrequest.readyState==4 && mygetrequest.status==200){
                    console.log("GetNewData: " + mygetrequest.responseText)
                } 
            }*/
            if(!get_data_clicked){
                get_data_clicked = true
                mygetrequest.open("GET", "http://localhost:8080/data_new", true);
                mygetrequest.send();
                getStatus();
            }
        });
      
        // perfrom an initial plot of the data
        var current_sensor_data = [];
        $.plot("#placeholder", current_sensor_data, options);
      
        // get new sensor data from the database
        function getSensorData(){
            var mygetrequest = new XMLHttpRequest();
            mygetrequest.onreadystatechange=function(){
                if (mygetrequest.readyState==4 && mygetrequest.status==200){
                    // process json data from the sensor network
                    var temp_sensor_json = []
                    json_me = JSON.parse(mygetrequest.responseText)
                    for(i = 0; i < json_me.length; i++){
                        json_me[i].temp.label = "sensor_"+i
                        temp_sensor_json.push(json_me[i].temp)
                        temp_clock = json_me[i].temp.data[json_me[i].temp.data.length-1][0]
                        if(newest_clock < temp_clock){
                            newest_clock = temp_clock
                            document.getElementById("newest_time").innerHTML = 
                                    "Latest Value:  " + new Date(newest_clock)
                        }
                    }
                    updateGraphData(temp_sensor_json)
                    current_sensor_data = temp_sensor_json
                } 
            }
            mygetrequest.open("GET", "http://localhost:8080/data_sensor", true);
            mygetrequest.send();
        }
      
        // update the line graph with new data
        function updateGraphData(temp_data){
            //console.log(temp_data)
            if(current_option == "today"){
                set_option_today();
            } else if (current_option == "all"){
                set_option_all();
            } else {
                for(i = 0; i < temp_data.length; i++){
                    data_len = temp_data[0].data.length
                    temp_data[i].data = temp_data[i].data.slice(data_len-10,data_len)
                    //console.log(temp_data[i].data)
                }
                set_option_recent();
            }
            $.plot("#placeholder", temp_data, options);
        }
        
        // get status of the get command
        function getStatus(){
            var mygetrequest = new XMLHttpRequest(); 
            mygetrequest.onreadystatechange=function(){
                if (mygetrequest.readyState==4 && mygetrequest.status==200){
                    document.getElementById("getdata_status").innerHTML = mygetrequest.responseText
                    console.log(mygetrequest.responseText);
                    if(mygetrequest.responseText.indexOf("waiting for response") > -1){
                        setTimeout(getStatus, 200);
                    } else {
                        get_data_clicked = false;
                    }
                } 
            }     
            mygetrequest.open("GET", "http://localhost:8080/get_data_status", true);
            mygetrequest.send();
        }
        
        // run once, then get new sensor data every 10 secs
        getSensorData()
        setInterval(getSensorData, 1000);
    });
    </script>
    <body>
        <!-- Site navigation menu -->
        <ul class="navbar">
            <li><a href="project-info.html">Project Info</a>
            <li><a href="water-control.html">Water Control</a>
            <li><a href="weather.html">Weather</a>
            <li><a href="temperature.html">Temperature</a>
            <li><a href="pressure.html">Pressure</a>
            <li><a href="humidity.html">Humidity</a>
            <li><a href="light.html">Light</a>
            <li><a href="soil-moisture.html">Soil Moisture</a>
            <li><a href="hardware-design.html">Hardware Design</a>
            <li><a href="software-design.html">Software Design</a>
        </ul>
        
        <!-- Main content -->
        <h2>Temperature</h2>
        
        <div id="content">
            <div class="demo-container">
                <div id="placeholder" class="demo-placeholder" style="float:left; width:675px;"></div>
                <p id="choices" style="float:right; width:135px;"></p>
            </div>
            <center><t id="newest_time"></t></center>
            <p>Graph Selection: <button id="recent">Recent Data</button>
            <button id="today">Today's Data</button>
            <button id="all">All Data</button></p>
            <p>Get New Data: . .<button id="getdata">Get Data</button>
            <n>. . . . . .</n><m id="getdata_status"></m></p>
            <p>Temperature is a measurement of the heat/energy present in the air. As the 
            temperature increases, the energy causes water in the soil to evaporate more 
            quickly which results in the soil requiring more water. The temperature can be 
            used to predict how quickly the soil moisture will change and preventative 
            measures can be taken.</p>
        </div>
        
    </body>
</html>